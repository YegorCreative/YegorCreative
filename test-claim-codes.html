<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Claim Code Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-group { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        input { padding: 8px; width: 300px; }
        button { padding: 8px 16px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Fasting Claim Code System Test</h1>
    
    <div class="test-group">
        <h2>1. Hash Function Test</h2>
        <p>Testing FNV-1a hash consistency</p>
        <button onclick="testHashFunction()">Test Hash</button>
        <div id="hashResult"></div>
    </div>

    <div class="test-group">
        <h2>2. Code Generation Test</h2>
        <p>Generate a test code for milestone 5 on Jan 10, 2026</p>
        <button onclick="testCodeGeneration()">Generate Code</button>
        <div id="codeResult"></div>
    </div>

    <div class="test-group">
        <h2>3. Code Validation Test</h2>
        <p>Validate the generated code</p>
        <input type="text" id="testCode" placeholder="Paste code here" />
        <button onclick="testCodeValidation()">Validate Code</button>
        <div id="validationResult"></div>
    </div>

    <div class="test-group">
        <h2>4. Cross-Validation Test</h2>
        <p>Generate and validate in sequence</p>
        <button onclick="testCrossValidation()">Run Full Test</button>
        <div id="crossValidationResult"></div>
    </div>

    <script>
        const CLAIM_SECRET = 'YEGORCREATIVE_FASTING_2026';
        const MILESTONES = [5, 10, 15, 20, 25, 30, 35, 40];

        function fnv1a(str) {
            let hash = 2166136261;
            for (let i = 0; i < str.length; i++) {
                hash ^= str.charCodeAt(i);
                hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
                hash = hash >>> 0;
            }
            return Math.abs(hash).toString(36).toUpperCase().slice(0, 6);
        }

        function generateClaimCode(milestone, dateStr) {
            const hashInput = `${milestone}|${dateStr}|${CLAIM_SECRET}`;
            const hash = fnv1a(hashInput);
            return `FAST-${milestone}-${dateStr}-${hash}`;
        }

        function parseClaimCode(code) {
            const trimmed = code.trim().toUpperCase();
            const parts = trimmed.split('-');
            
            if (parts.length !== 4) {
                return { error: 'Invalid code format' };
            }

            const [prefix, milestoneStr, dateStr, hash] = parts;

            if (prefix !== 'FAST') {
                return { error: 'Code must start with FAST' };
            }

            const milestone = parseInt(milestoneStr, 10);
            if (isNaN(milestone) || !MILESTONES.includes(milestone)) {
                return { error: 'Invalid milestone' };
            }

            if (!/^\d{8}$/.test(dateStr)) {
                return { error: 'Date must be YYYYMMDD' };
            }

            if (!/^[A-Z0-9]{6}$/.test(hash)) {
                return { error: 'Hash must be 6 chars' };
            }

            return { milestone, dateStr, hash };
        }

        function verifyClaimCode(milestone, dateStr, providedHash) {
            const hashInput = `${milestone}|${dateStr}|${CLAIM_SECRET}`;
            const computedHash = fnv1a(hashInput);
            return computedHash === providedHash.toUpperCase();
        }

        function testHashFunction() {
            const result = document.getElementById('hashResult');
            const input = '5|20260110|YEGORCREATIVE_FASTING_2026';
            const hash1 = fnv1a(input);
            const hash2 = fnv1a(input);
            
            let html = `<p>Input: ${input}</p>`;
            html += `<p>First call: ${hash1}</p>`;
            html += `<p>Second call: ${hash2}</p>`;
            
            if (hash1 === hash2) {
                html += `<p class="success">✓ Hash is deterministic (consistent)</p>`;
            } else {
                html += `<p class="error">✗ Hash is not deterministic (inconsistent)</p>`;
            }
            
            result.innerHTML = html;
        }

        function testCodeGeneration() {
            const result = document.getElementById('codeResult');
            const milestone = 5;
            const dateStr = '20260110';
            const code = generateClaimCode(milestone, dateStr);
            
            let html = `<p>Milestone: ${milestone}</p>`;
            html += `<p>Date: ${dateStr}</p>`;
            html += `<p>Generated Code:</p>`;
            html += `<pre>${code}</pre>`;
            html += `<button onclick="copyToClipboard('${code}')">Copy Code</button>`;
            
            document.getElementById('testCode').value = code;
            result.innerHTML = html;
        }

        function testCodeValidation() {
            const result = document.getElementById('validationResult');
            const code = document.getElementById('testCode').value;
            
            if (!code) {
                result.innerHTML = '<p class="error">Please generate or paste a code first</p>';
                return;
            }

            const parsed = parseClaimCode(code);
            if (parsed.error) {
                result.innerHTML = `<p class="error">Parse Error: ${parsed.error}</p>`;
                return;
            }

            const isValid = verifyClaimCode(parsed.milestone, parsed.dateStr, parsed.hash);
            
            let html = `<p>Parsed milestone: ${parsed.milestone}</p>`;
            html += `<p>Parsed date: ${parsed.dateStr}</p>`;
            html += `<p>Provided hash: ${parsed.hash}</p>`;
            
            if (isValid) {
                html += `<p class="success">✓ Code is valid!</p>`;
            } else {
                html += `<p class="error">✗ Code validation failed</p>`;
            }
            
            result.innerHTML = html;
        }

        function testCrossValidation() {
            const result = document.getElementById('crossValidationResult');
            let html = '<h3>Cross-Validation Results</h3>';
            
            const tests = [
                { milestone: 5, dateStr: '20260110' },
                { milestone: 10, dateStr: '20260115' },
                { milestone: 40, dateStr: '20260210' }
            ];
            
            let allPassed = true;
            
            for (const test of tests) {
                const code = generateClaimCode(test.milestone, test.dateStr);
                const parsed = parseClaimCode(code);
                const isValid = verifyClaimCode(parsed.milestone, parsed.dateStr, parsed.hash);
                
                html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">`;
                html += `<p><strong>Milestone ${test.milestone} (${test.dateStr}):</strong></p>`;
                html += `<p style="font-family: monospace; margin: 5px 0;">${code}</p>`;
                
                if (isValid) {
                    html += `<p class="success">✓ Valid</p>`;
                } else {
                    html += `<p class="error">✗ Invalid</p>`;
                    allPassed = false;
                }
                html += `</div>`;
            }
            
            if (allPassed) {
                html += `<p class="success"><strong>✓ All tests passed!</strong></p>`;
            } else {
                html += `<p class="error"><strong>✗ Some tests failed</strong></p>`;
            }
            
            result.innerHTML = html;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Code copied to clipboard!');
            });
        }

        // Run cross-validation on load
        window.addEventListener('load', testCrossValidation);
    </script>
</body>
</html>
